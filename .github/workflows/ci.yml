name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

defaults:
  run:
    working-directory: sources/prisma-neighbourhood

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.1.43"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Lint
        run: bun run lint

  test:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Chromium dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libasound2
        working-directory: .

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.1.43"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Test
        run: bun run test

  build:
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.1.43"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate type declarations
        run: tsc --emitDeclarationOnly

      - name: Build CLI
        run: bun run build:cli

      - name: Build library
        run: bun run build:index

      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: sources/prisma-neighbourhood/dist/
          retention-days: 1

  examples:
    runs-on: ubuntu-22.04
    needs: [build]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Chromium dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libasound2
        working-directory: .

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.1.43"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: sources/prisma-neighbourhood/dist/

      - name: Make CLI executable
        run: chmod +x ./dist/cli.js

      - name: Generate ERD diagrams
        run: bun run generate:examples

      - name: Upload ERD artifacts
        uses: actions/upload-artifact@v4
        with:
          name: erd-diagrams
          path: sources/prisma-neighbourhood/examples/output/
          retention-days: 1
