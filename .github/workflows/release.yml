name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write
  id-token: write

defaults:
  run:
    working-directory: sources/prisma-neighborhood

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.1.43"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Lint
        run: bun run lint

  test:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Chromium dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libasound2
        working-directory: .

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.1.43"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Test
        run: bun run test

  build:
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.1.43"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        run: bun run build

      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: sources/prisma-neighborhood/dist/
          retention-days: 30

  examples:
    runs-on: ubuntu-22.04
    needs: [build]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Chromium dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libasound2
        working-directory: .

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.1.43"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: sources/prisma-neighborhood/dist/

      - name: Make CLI executable
        run: chmod +x ./dist/cli.js

      - name: Generate ERD diagrams
        run: bun run generate:examples

      - name: Upload examples artifact
        uses: actions/upload-artifact@v4
        with:
          name: examples
          path: sources/prisma-neighborhood/examples/output/
          retention-days: 30

  github_release:
    runs-on: ubuntu-latest
    needs: [build, examples]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.1.43"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: sources/prisma-neighborhood/dist/

      - name: Download examples artifact
        uses: actions/download-artifact@v4
        with:
          name: examples
          path: sources/prisma-neighborhood/examples-output/

      - name: Pack
        run: npm pack --ignore-scripts

      - name: Zip dist
        run: zip -r dist.zip dist/

      - name: Zip examples
        run: zip -r examples.zip examples-output/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            sources/prisma-neighborhood/*.tgz
            sources/prisma-neighborhood/dist.zip
            sources/prisma-neighborhood/examples.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  npm_publish:
    runs-on: ubuntu-latest
    needs: [build, examples]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.1.43"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: sources/prisma-neighborhood/dist/

      - name: Pack
        run: npm pack --ignore-scripts

      - name: Skip npm publish (bootstrap release only)
        run: |
          echo "npm publish is intentionally disabled for now."
          echo "Publish v0.0.1 manually, then enable Trusted Publishing for v0.0.2+."
