# prisma-neighbourhood

Generate focused, high-quality ERD diagrams from Prisma schemas. Instead of overwhelming full-schema diagrams, prisma-neighbourhood traverses relationships from any starting model to a configurable depth, showing only the relevant "neighborhood" of connected entities.

Perfect for:
- **Onboarding**: Show new developers just the domain they need, not 200+ models
- **Impact analysis**: See exactly what's affected before modifying a model
- **Documentation**: Generate crisp SVG diagrams that stay in sync with your actual schema
- **Architecture reviews**: Visualize bounded contexts and identify coupling

Outputs to SVG (recommended for highest quality), PNG, PDF, or raw Mermaid syntax.

## Installation

### Run without installing (recommended)
bunx @matserdam/prisma-neighborhood [options]
bunx @matserdam/prisma-neighborhood [options]

### Install globally
npm install -g @matserdam/prisma-neighborhood

## Quick Start

# Visualize the neighborhood around User model
bunx @matserdam/prisma-neighborhood -s ./prisma/schema.prisma -m User

# Show only direct relationships (depth 1)
bunx @matserdam/prisma-neighborhood -s ./prisma/schema.prisma -m User -d 1

# Export as SVG (highest quality, recommended)
bunx @matserdam/prisma-neighborhood -s ./prisma/schema.prisma -m User -o docs/erd.svg

# Export as PNG (for platforms that don't support SVG)
bunx @matserdam/prisma-neighborhood -s ./prisma/schema.prisma -m User -o docs/erd.png

## CLI Options

| Option | Alias | Description | Default |
|--------|-------|-------------|---------|
| --schema <path> | -s | Path to Prisma schema file | required |
| --model <name> | -m | Model to start traversal from | required |
| --depth <n> | -d | Number of relationship levels to traverse | 3 |
| --output <file> | -o | Output file (.mmd, .md, .svg, .png, .pdf) | stdout |
| --renderer <name> | -r | Diagram renderer to use | vector |
| --list-renderers | | Show available renderers | |
| --help | -h | Show help | |
| --version | -V | Show version | |

## Output Formats

| Extension | Format | Use Case |
|-----------|--------|----------|
| .svg | SVG vector (recommended) | Highest quality, infinite zoom, crisp at any size, transparent background |
| .png | PNG image (300 DPI) | Confluence, Slack, platforms that don't support SVG |
| .pdf | PDF document | Print, formal architecture documentation |
| .mmd | Mermaid syntax | Embed in markdown, preview in VS Code, use mermaid.live |
| .md | Mermaid syntax | Same as .mmd |

### Export Pipeline

SVG, PNG, and PDF exports use @mermaid-js/mermaid-cli for accurate diagram rendering:

- **SVG**: Generated directly by mermaid-cli. Highest quality, perfect for documentation and web.
- **PNG**: Derived from SVG, converted to 300 DPI via sharp. Use when SVG not supported.
- **PDF**: High-DPI PNG embedded in PDF document via pdfkit.

## Examples by Use Case

### Onboarding: Show a new developer just one domain
# Authentication domain only, not the full 200-model schema
bunx @matserdam/prisma-neighborhood -s schema.prisma -m User -d 2 -o docs/auth-domain.svg

# Order processing domain for new backend developer
bunx @matserdam/prisma-neighborhood -s schema.prisma -m Order -d 2 -o docs/orders-domain.svg

### Stakeholder communication: Generate diagrams for non-technical audience
bunx @matserdam/prisma-neighborhood -s prisma/schema.prisma -m Product -d 2 -o slides/product-model.png
bunx @matserdam/prisma-neighborhood -s prisma/schema.prisma -m Customer -d 2 -o slides/customer-model.pdf

### Impact analysis: See what models are affected by a change
# Before modifying User, see everything within 2 hops
bunx @matserdam/prisma-neighborhood -s schema.prisma -m User -d 2

# Check impact radius of Invoice changes
bunx @matserdam/prisma-neighborhood -s schema.prisma -m Invoice -d 2 -o impact-analysis.svg

### Code review: Visualize models touched by a PR
# PR touches Order, OrderItem, Payment - see how they connect
bunx @matserdam/prisma-neighborhood -s schema.prisma -m Order -d 1 -o pr-context.svg

### Domain-Driven Design: Identify bounded context boundaries
# Visualize neighborhood around each aggregate root
bunx @matserdam/prisma-neighborhood -s schema.prisma -m Order -d 3 -o contexts/order-aggregate.mmd
bunx @matserdam/prisma-neighborhood -s schema.prisma -m User -d 3 -o contexts/user-aggregate.mmd
bunx @matserdam/prisma-neighborhood -s schema.prisma -m Product -d 3 -o contexts/product-aggregate.mmd

### Check coupling: Does adding a relation create unwanted dependencies?
# Before: visualize Order neighborhood
bunx @matserdam/prisma-neighborhood -s schema.prisma -m Order -d 2 -o before.mmd
# After adding relation: check if UserPreferences now appears
bunx @matserdam/prisma-neighborhood -s schema.prisma -m Order -d 2 -o after.mmd

### Microservice decomposition: See what models cluster together
# What belongs in the Order service?
bunx @matserdam/prisma-neighborhood -s schema.prisma -m Order -d 3 -o services/order-service.svg

# What belongs in the User service?
bunx @matserdam/prisma-neighborhood -s schema.prisma -m User -d 3 -o services/user-service.svg

# Compare outputs to identify shared models (potential API boundaries)

### Database migration planning: Understand table dependencies
# What tables cascade from Product?
bunx @matserdam/prisma-neighborhood -s schema.prisma -m Product -d 3

# Plan migration order based on relationship graph
bunx @matserdam/prisma-neighborhood -s schema.prisma -m Inventory -d 2 -o migration-scope.svg

### Documentation: Keep ERDs in sync with actual schema
# Regenerate focused diagrams from current schema
bunx @matserdam/prisma-neighborhood -s prisma/schema.prisma -m User -o docs/user-erd.svg
bunx @matserdam/prisma-neighborhood -s prisma/schema.prisma -m Order -o docs/order-erd.svg

# Generate Mermaid for embedding in README
bunx @matserdam/prisma-neighborhood -s prisma/schema.prisma -m Post -o README-diagram.mmd

### CI/CD: Automated documentation generation
# In GitHub Actions workflow
bunx @matserdam/prisma-neighborhood -s prisma/schema.prisma -m User -d 3 -o docs/generated/user-erd.svg
bunx @matserdam/prisma-neighborhood -s prisma/schema.prisma -m Order -d 3 -o docs/generated/order-erd.svg

### Automation: Auto-regenerate on schema changes

#### macOS (using fswatch)
Watch for changes and regenerate diagram automatically:
```bash
fswatch -o prisma/schema.prisma | xargs -n1 -I{} bunx @matserdam/prisma-neighborhood -s prisma/schema.prisma -m AnalyticsEvent -d 1 -o docs/analytics.svg
```

#### Linux (using inotifywait)
Watch for file modification events:
```bash
while inotifywait -e modify prisma/schema.prisma; do
  bunx @matserdam/prisma-neighborhood -s prisma/schema.prisma -m AnalyticsEvent -d 1 -o docs/analytics.svg
done
```

#### Makefile (Build-time generation)
Regenerate diagrams only if schema is newer than the output file:
```makefile
# Usage: make docs/User.svg
docs/%.svg: prisma/schema.prisma
	bunx @matserdam/prisma-neighborhood -s $< -m $* -d 2 -o $@
```

#### package.json (using nodemon)
Development script to watch and rebuild:
```json
{
  "scripts": {
    "watch:erd": "nodemon --watch prisma/schema.prisma --exec 'bunx @matserdam/prisma-neighborhood -s prisma/schema.prisma -m User -o docs/user.svg'"
  }
}
```

## Understanding Depth

The --depth flag controls how many relationship levels to traverse from the starting model.

| Depth | What it shows |
|-------|---------------|
| 1 | Start model + directly related models only |
| 2 | Above + models related to those (2 hops) |
| 3 | Default. Good balance for most schemas |
| 4-5 | Deep exploration, may get large |

Example: User -> Post -> Comment -> Author

depth=1 shows: User, Post
depth=2 shows: User, Post, Comment
depth=3 shows: User, Post, Comment, Author

Use depth=1 for focused impact analysis.
Use depth=2-3 for domain understanding.
Use depth=4+ for exploring complex interconnections.

## Understanding the Output

The generated diagram visualizes your Prisma schema using standard Crow's Foot notation:

### Entities
- **Header**: The model name (e.g., `User`, `Order`)
- **Body**: List of fields with their types and constraints
  - **PK**: Primary Key
  - **UK**: Unique Key
  - **FK**: Foreign Key (implicit in Prisma relations)

### Relationships
Lines connect related models with markers indicating cardinality:
- `||--||`: One-to-One
- `||--o|`: One-to-Zero-or-One
- `||--o{`: One-to-Many
- `}o--o{`: Many-to-Many (implicit or explicit)

The **starting model** (specified by `-m`) is central to the graph structure, with all other models radiating out based on the traversal depth.

## Troubleshooting

### Export uses mermaid-cli
SVG/PNG/PDF export uses @mermaid-js/mermaid-cli which handles Puppeteer/Chromium automatically. No manual browser setup required.

### Model not found error
Model names are case-sensitive. Check exact spelling in your schema.prisma:

model User { ... }    # Use: -m User
model OrderItem { }   # Use: -m OrderItem (not orderitem)

### Schema file not found
Ensure the path to your schema is correct relative to your current directory:
`bunx ... -s ./prisma/schema.prisma` vs `bunx ... -s ./schema.prisma`

### Diagram shows too many models
Reduce depth to limit scope:

# Too much? Try depth 1 for direct relations only
bunx @matserdam/prisma-neighborhood -s schema.prisma -m User -d 1

# Still too much? Your model may be a "God object" with too many relations

### Output is empty or missing models
- Ensure the model has relations defined in your schema. Scalar-only models produce minimal output.
- Check if your schema has syntax errors (run `npx prisma validate`).

### Permission denied on output
If writing to a directory (e.g., `docs/`), ensure the directory exists and you have write permissions:
`mkdir -p docs && bunx ...`

### Large diagram performance
For very deep traversals (depth 5+) on large schemas:
- Prefer SVG output (scales better than PNG)
- Increase Node memory if needed: `NODE_OPTIONS="--max-old-space-size=4096" bunx ...`

