# prisma-neighbourhood

Generate focused, high-quality ERD diagrams from Prisma schemas. Instead of overwhelming full-schema diagrams, prisma-neighbourhood traverses relationships from any starting entity (model, view, or enum) to a configurable depth, showing only the relevant "neighborhood" of connected entities.

Perfect for:
- **Onboarding**: Show new developers just the domain they need, not 200+ models
- **Impact analysis**: See exactly what's affected before modifying a model
- **Documentation**: Generate crisp SVG diagrams that stay in sync with your actual schema
- **Architecture reviews**: Visualize bounded contexts and identify coupling

Outputs to SVG (recommended for highest quality), PNG, PDF, or raw Mermaid syntax.

## Installation

### Run without installing (recommended)
bunx @matserdam/prisma-neighborhood [options]

### Install globally
npm install -g @matserdam/prisma-neighborhood

## Quick Start

# Visualize the neighborhood around User model
bunx @matserdam/prisma-neighborhood -s ./prisma/schema.prisma -m User

# Start from a view (shows view + related enums/models)
bunx @matserdam/prisma-neighborhood -s ./prisma/schema.prisma -m UserSummary -d 2

# Start from an enum (shows enum + all models/views using it)
bunx @matserdam/prisma-neighborhood -s ./prisma/schema.prisma -m UserRole -d 2

# Show only direct relationships (depth 1)
bunx @matserdam/prisma-neighborhood -s ./prisma/schema.prisma -m User -d 1

# Export as SVG (highest quality, recommended)
bunx @matserdam/prisma-neighborhood -s ./prisma/schema.prisma -m User -o docs/erd.svg

# Export as PNG (for platforms that don't support SVG)
bunx @matserdam/prisma-neighborhood -s ./prisma/schema.prisma -m User -o docs/erd.png

## CLI Options

| Option | Alias | Description | Default |
|--------|-------|-------------|---------|
| --schema <path> | -s | Path to Prisma schema file | required |
| --model <name> | -m | Entity to start traversal from (model, view, or enum) | required |
| --depth <n> | -d | Number of relationship levels to traverse | 3 |
| --output <file> | -o | Output file (.mmd, .md, .svg, .png, .pdf) | stdout |
| --renderer <name> | -r | Diagram renderer to use | vector |
| --list-renderers | | Show available renderers | |
| --help | -h | Show help | |
| --version | -V | Show version | |

## Entity Types

### Models
Regular Prisma models are displayed as standard ERD entities with field types and constraints (PK, UK).

### Views (requires Prisma views preview feature)
Views are displayed with a `[view]` prefix in the entity name. Views can have relations and enum fields which are traversed normally.

```prisma
view UserSummary {
  id    Int    @unique
  email String
  role  UserRole
}
```

Renders as:
```
"[view] UserSummary" {
  Int id UK
  String email
  UserRole role
}
```

### Enums
Enums are displayed with an `[enum]` prefix. Each enum value is shown with the enum name as its type.

```prisma
enum UserRole {
  ADMIN
  USER
  GUEST
}
```

Renders as:
```
"[enum] UserRole" {
  UserRole ADMIN
  UserRole USER
  UserRole GUEST
}
```

## Traversal Behavior

### Starting from a Model
Traverses to related models/views via relations, and to enums via enum-typed fields.

### Starting from a View
Traverses to related models/views via relations, and to enums via enum-typed fields.

### Starting from an Enum
Finds all models and views that use this enum type in their fields. At depth 2+, continues traversing their relations.

Example: Starting from `UserRole` enum at depth 2:
- Depth 0: UserRole (the enum itself)
- Depth 1: User, AuditLog (models using UserRole)
- Depth 2: Post, Profile (models related to User)

## Output Formats

| Extension | Format | Use Case |
|-----------|--------|----------|
| .svg | SVG vector (recommended) | Highest quality, infinite zoom, crisp at any size, transparent background |
| .png | PNG image (300 DPI) | Confluence, Slack, platforms that don't support SVG |
| .pdf | PDF document | Print, formal architecture documentation |
| .mmd | Mermaid syntax | Embed in markdown, preview in VS Code, use mermaid.live |
| .md | Mermaid syntax | Same as .mmd |

### Export Pipeline

SVG, PNG, and PDF exports use @mermaid-js/mermaid-cli for accurate diagram rendering:

- **SVG**: Generated directly by mermaid-cli. Highest quality, perfect for documentation and web.
- **PNG**: Derived from SVG, converted to 300 DPI via sharp. Use when SVG not supported.
- **PDF**: High-DPI PNG embedded in PDF document via pdfkit.

## Examples by Use Case

### Onboarding: Show a new developer just one domain
# Authentication domain only, not the full 200-model schema
bunx @matserdam/prisma-neighborhood -s schema.prisma -m User -d 2 -o docs/auth-domain.svg

# Order processing domain for new backend developer
bunx @matserdam/prisma-neighborhood -s schema.prisma -m Order -d 2 -o docs/orders-domain.svg

### Enum usage analysis: See all entities using an enum
# Which models/views use the OrderStatus enum?
bunx @matserdam/prisma-neighborhood -s schema.prisma -m OrderStatus -d 2 -o docs/order-status-usage.svg

# Which models use the UserRole enum?
bunx @matserdam/prisma-neighborhood -s schema.prisma -m UserRole -d 2 -o docs/role-usage.svg

### View exploration: Understand view relationships
# See what a reporting view connects to
bunx @matserdam/prisma-neighborhood -s schema.prisma -m UserSummaryView -d 2 -o docs/summary-view.svg

### Impact analysis: See what models are affected by a change
# Before modifying User, see everything within 2 hops
bunx @matserdam/prisma-neighborhood -s schema.prisma -m User -d 2

# Check impact radius of Invoice changes
bunx @matserdam/prisma-neighborhood -s schema.prisma -m Invoice -d 2 -o impact-analysis.svg

### Code review: Visualize models touched by a PR
# PR touches Order, OrderItem, Payment - see how they connect
bunx @matserdam/prisma-neighborhood -s schema.prisma -m Order -d 1 -o pr-context.svg

### Domain-Driven Design: Identify bounded context boundaries
# Visualize neighborhood around each aggregate root
bunx @matserdam/prisma-neighborhood -s schema.prisma -m Order -d 3 -o contexts/order-aggregate.mmd
bunx @matserdam/prisma-neighborhood -s schema.prisma -m User -d 3 -o contexts/user-aggregate.mmd
bunx @matserdam/prisma-neighborhood -s schema.prisma -m Product -d 3 -o contexts/product-aggregate.mmd

### Check coupling: Does adding a relation create unwanted dependencies?
# Before: visualize Order neighborhood
bunx @matserdam/prisma-neighborhood -s schema.prisma -m Order -d 2 -o before.mmd
# After adding relation: check if UserPreferences now appears
bunx @matserdam/prisma-neighborhood -s schema.prisma -m Order -d 2 -o after.mmd

### Microservice decomposition: See what models cluster together
# What belongs in the Order service?
bunx @matserdam/prisma-neighborhood -s schema.prisma -m Order -d 3 -o services/order-service.svg

# What belongs in the User service?
bunx @matserdam/prisma-neighborhood -s schema.prisma -m User -d 3 -o services/user-service.svg

# Compare outputs to identify shared models (potential API boundaries)

### Documentation: Keep ERDs in sync with actual schema
# Regenerate focused diagrams from current schema
bunx @matserdam/prisma-neighborhood -s prisma/schema.prisma -m User -o docs/user-erd.svg
bunx @matserdam/prisma-neighborhood -s prisma/schema.prisma -m Order -o docs/order-erd.svg

## Understanding Depth

The --depth flag controls how many relationship levels to traverse from the starting entity.

| Depth | What it shows |
|-------|---------------|
| 0 | Start entity only |
| 1 | Start entity + directly related entities |
| 2 | Above + entities related to those (2 hops) |
| 3 | Default. Good balance for most schemas |
| 4-5 | Deep exploration, may get large |

Example: User -> Post -> Comment -> Author

depth=1 shows: User, Post
depth=2 shows: User, Post, Comment
depth=3 shows: User, Post, Comment, Author

Example: UserRole enum -> User model -> Post model

depth=1 shows: UserRole, User (uses the enum)
depth=2 shows: UserRole, User, Post (related to User)

Use depth=1 for focused impact analysis.
Use depth=2-3 for domain understanding.
Use depth=4+ for exploring complex interconnections.

## Understanding the Output

The generated diagram visualizes your Prisma schema using standard Crow's Foot notation:

### Entities
- **Models**: Plain entity name (e.g., `User`, `Order`)
- **Views**: Prefixed with `[view]` (e.g., `"[view] UserSummary"`)
- **Enums**: Prefixed with `[enum]` (e.g., `"[enum] UserRole"`)

### Fields
- **PK**: Primary Key
- **UK**: Unique Key
- **FK**: Foreign Key (implicit in Prisma relations)
- Enum values show the enum name as their type

### Relationships
Lines connect related entities with markers indicating cardinality:
- `||--||`: One-to-One
- `||--o|`: One-to-Zero-or-One
- `||--o{`: One-to-Many
- `}o--o{`: Many-to-Many (implicit or explicit)
- `}o--||`: Enum usage (model/view uses enum)

## Troubleshooting

### Export uses mermaid-cli
SVG/PNG/PDF export uses @mermaid-js/mermaid-cli which handles Puppeteer/Chromium automatically. No manual browser setup required.

### Entity not found error
Entity names are case-sensitive. Check exact spelling in your schema.prisma:

model User { ... }    # Use: -m User
enum UserRole { }     # Use: -m UserRole
view UserSummary { }  # Use: -m UserSummary

### Schema file not found
Ensure the path to your schema is correct relative to your current directory:
`bunx ... -s ./prisma/schema.prisma` vs `bunx ... -s ./schema.prisma`

### Views not recognized
Ensure you have the views preview feature enabled in your schema:

```prisma
generator client {
  provider        = "prisma-client"
  previewFeatures = ["views"]
}
```

### Diagram shows too many models
Reduce depth to limit scope:

# Too much? Try depth 1 for direct relations only
bunx @matserdam/prisma-neighborhood -s schema.prisma -m User -d 1

# Still too much? Your model may be a "God object" with too many relations

### Output is empty or missing models
- Ensure the entity has relations or enum fields defined. Scalar-only models produce minimal output.
- Check if your schema has syntax errors (run `npx prisma validate`).

### Permission denied on output
If writing to a directory (e.g., `docs/`), ensure the directory exists and you have write permissions:
`mkdir -p docs && bunx ...`
